<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LAPLACE Event Bridge Client Example</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }

      h1,
      h2 {
        color: #333;
      }

      .button {
        background-color: #4a90e2;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 8px;
      }

      .button:hover {
        background-color: #357bd8;
      }

      .button-disconnect {
        background-color: #e24a4a;
      }

      .button-disconnect:hover {
        background-color: #d83535;
      }

      .event-log {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 300px;
        overflow-y: auto;
        padding: 12px;
        font-family: monospace;
        margin-bottom: 16px;
      }

      .event-type {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 8px;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .event-type-message {
        background-color: #4a90e2;
      }

      .event-type-system {
        background-color: #e2c94a;
      }

      .event-type-other {
        background-color: #4ae27c;
      }

      .controls {
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <h1>LAPLACE Event Bridge Client Example</h1>

    <div class="controls">
      <button id="connect-btn" class="button">Connect</button>
      <button id="disconnect-btn" class="button button-disconnect" disabled>Disconnect</button>
      <span id="connection-status">Not connected</span>
    </div>

    <h2>Event Log</h2>
    <div id="event-log" class="event-log"></div>

    <h2>Send System Message</h2>
    <div>
      <input type="text" id="message-input" placeholder="Enter system message" style="padding: 8px; width: 300px" />
      <button id="send-btn" class="button" disabled>Send</button>
    </div>

    <script type="module">
      // Import the SDK (in a real app, you would import from the npm package)
      // For this example, we're defining a simplified version of the SDK inline
      class LaplaceEventBridgeClient {
        constructor(options = {}) {
          this.options = {
            url: 'ws://localhost:9696',
            token: 'laplace',
            reconnect: true,
            reconnectInterval: 3000,
            maxReconnectAttempts: 10,
            ...options,
          }

          this.ws = null
          this.eventHandlers = new Map()
          this.anyEventHandlers = []
          this.reconnectTimer = null
          this.reconnectAttempts = 0
          this.clientId = null
          this.isConnected = false
        }

        connect() {
          return new Promise((resolve, reject) => {
            try {
              if (this.ws) {
                this.ws.close()
              }

              const protocols = []
              if (this.options.token) {
                protocols.push('laplace-event-bridge-role-client', this.options.token)
              }

              this.ws = new WebSocket(this.options.url, protocols)

              this.ws.onopen = () => {
                this.isConnected = true
                this.reconnectAttempts = 0
                console.log('Connected to LAPLACE Event Bridge')
                resolve()
              }

              this.ws.onmessage = event => {
                try {
                  const data = JSON.parse(event.data)

                  // Store client ID from the established message
                  if (data.type === 'established' && data.clientId) {
                    this.clientId = data.clientId
                    console.log(`Connection established with client ID: ${this.clientId}`)
                  }

                  // Process the event
                  this.processEvent(data)
                } catch (err) {
                  console.error('Failed to parse event data:', err)
                }
              }

              this.ws.onerror = error => {
                console.error('WebSocket error:', error)
                reject(error)
              }

              this.ws.onclose = () => {
                this.isConnected = false
                console.log('Disconnected from LAPLACE Event Bridge')

                if (this.options.reconnect && this.reconnectAttempts < this.options.maxReconnectAttempts) {
                  this.reconnectAttempts++
                  console.log(
                    `Attempting to reconnect (${this.reconnectAttempts}/${this.options.maxReconnectAttempts})...`
                  )
                  this.reconnectTimer = setTimeout(() => {
                    this.connect().catch(err => {
                      console.error('Reconnection failed:', err)
                    })
                  }, this.options.reconnectInterval)
                }
              }
            } catch (err) {
              reject(err)
            }
          })
        }

        disconnect() {
          if (this.reconnectTimer) {
            clearTimeout(this.reconnectTimer)
            this.reconnectTimer = null
          }

          if (this.ws) {
            this.ws.close()
            this.ws = null
          }

          this.isConnected = false
          this.clientId = null
        }

        on(eventType, handler) {
          if (!this.eventHandlers.has(eventType)) {
            this.eventHandlers.set(eventType, [])
          }
          this.eventHandlers.get(eventType).push(handler)
        }

        onAny(handler) {
          this.anyEventHandlers.push(handler)
        }

        off(eventType, handler) {
          if (!this.eventHandlers.has(eventType)) {
            return
          }

          const handlers = this.eventHandlers.get(eventType)
          const index = handlers.indexOf(handler)

          if (index !== -1) {
            handlers.splice(index, 1)
          }

          if (handlers.length === 0) {
            this.eventHandlers.delete(eventType)
          }
        }

        offAny(handler) {
          const index = this.anyEventHandlers.indexOf(handler)
          if (index !== -1) {
            this.anyEventHandlers.splice(index, 1)
          }
        }

        isConnectedToBridge() {
          return this.isConnected
        }

        getClientId() {
          return this.clientId
        }

        send(event) {
          if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            throw new Error('Not connected to LAPLACE Event Bridge')
          }

          this.ws.send(JSON.stringify(event))
        }

        processEvent(event) {
          // Call specific event handlers
          if (this.eventHandlers.has(event.type)) {
            for (const handler of this.eventHandlers.get(event.type)) {
              try {
                handler(event)
              } catch (err) {
                console.error(`Error in event handler for type ${event.type}:`, err)
              }
            }
          }

          // Call any event handlers
          for (const handler of this.anyEventHandlers) {
            try {
              handler(event)
            } catch (err) {
              console.error('Error in any event handler:', err)
            }
          }
        }
      }

      // Create an instance of the client
      const client = new LaplaceEventBridgeClient({
        url: 'ws://localhost:9696',
        reconnect: true,
      })

      // DOM elements
      const connectBtn = document.getElementById('connect-btn')
      const disconnectBtn = document.getElementById('disconnect-btn')
      const sendBtn = document.getElementById('send-btn')
      const messageInput = document.getElementById('message-input')
      const eventLog = document.getElementById('event-log')
      const connectionStatus = document.getElementById('connection-status')

      // Update UI based on connection state
      function updateConnectionUI(connected) {
        connectBtn.disabled = connected
        disconnectBtn.disabled = !connected
        sendBtn.disabled = !connected
        connectionStatus.textContent = connected ? `Connected (Client ID: ${client.getClientId()})` : 'Not connected'
        connectionStatus.style.color = connected ? 'green' : 'red'
      }

      // Log an event to the UI
      function logEvent(event) {
        const eventEl = document.createElement('div')

        let typeClass = 'event-type-other'
        if (event.type === 'message') {
          typeClass = 'event-type-message'
        } else if (event.type === 'system') {
          typeClass = 'event-type-system'
        }

        eventEl.innerHTML = `
        <div>
          <span class="event-type ${typeClass}">${event.type}</span>
          <span>${new Date().toISOString()}</span>
        </div>
        <pre>${JSON.stringify(event, null, 2)}</pre>
      `

        eventLog.appendChild(eventEl)
        eventLog.scrollTop = eventLog.scrollHeight
      }

      // Connect button
      connectBtn.addEventListener('click', async () => {
        try {
          await client.connect()
          updateConnectionUI(true)
          logEvent({
            type: 'local',
            message: 'Connected to LAPLACE Event Bridge',
          })
        } catch (error) {
          console.error('Connection error:', error)
          logEvent({
            type: 'error',
            message: `Connection error: ${error.message}`,
          })
        }
      })

      // Disconnect button
      disconnectBtn.addEventListener('click', () => {
        client.disconnect()
        updateConnectionUI(false)
        logEvent({
          type: 'local',
          message: 'Disconnected from LAPLACE Event Bridge',
        })
      })

      // Send button
      sendBtn.addEventListener('click', () => {
        const text = messageInput.value.trim()
        if (!text) return

        try {
          // Create a minimal system message for demo purposes
          const message = {
            type: 'system',
            id: `system-${Date.now()}`,
            message: text,
            timestamp: Date.now(),
            timestampNormalized: Date.now(),
            origin: 0,
            originIdx: 0,
            uid: 0,
            username: 'browser-demo',
            read: false,
          }

          client.send(message)
          messageInput.value = ''

          logEvent({
            type: 'local',
            message: `Sent system message: ${text}`,
          })
        } catch (error) {
          console.error('Failed to send message:', error)
          logEvent({
            type: 'error',
            message: `Failed to send message: ${error.message}`,
          })
        }
      })

      // Handle Enter key in message input
      messageInput.addEventListener('keydown', event => {
        if (event.key === 'Enter') {
          sendBtn.click()
        }
      })

      // Register event handlers
      client.onAny(event => {
        logEvent(event)
      })

      // Initialize UI
      updateConnectionUI(false)
    </script>
  </body>
</html>
